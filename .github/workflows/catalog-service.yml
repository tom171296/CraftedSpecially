
name: Catalog service CI/CD
run-name: ${{ github.actor }} is building the catalog service ðŸš€

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions: {}

jobs:

  build-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore ./Services/Catalog/Catalog.Api/Catalog.Api.csproj --locked-mode

      - name: Check for vulnerable dependencies
        run: dotnet list ./Services/Catalog/Catalog.Api/Catalog.Api.csproj package --vulnerable

      - name: Build
        run: dotnet build ./Services/Catalog/Catalog.Api/Catalog.Api.csproj --no-restore --configuration Release

      - name: Run unit tests
        run: dotnet test ./Services/Catalog/Catalog.Tests/Catalog.Tests.csproj --no-restore --no-build --logger trx

      # - name: Initialize CodeQL
      #   uses: github/codeql-action/init@v3
      #   with:
      #     languages: csharp

      # - name: Perform CodeQL Analysis
      #   uses: github/codeql-action/analyze@v3

      # - name: Log in to the Container registry
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ${{ env.REGISTRY }}
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}

      # - name: Build and push Docker image
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: ./Services/Catalog
      #     file: ./Services/Catalog/dockerfile
      #     push: true
      #     tags: ghcr.io/tom171296/craftedspecially/catalog-service:latest

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/TestResults/*.trx'

      - name: Fail if previous step failed
        if: failure()
        run: exit 1
